--- afl-as.h.orig	2014-06-29 08:52:52.000000000 +0200
+++ afl-as.h	2014-06-29 08:59:28.000000000 +0200
@@ -40,12 +40,12 @@
   "/* --- AFL TRAMPOLINE --- */\n"
   "\n"
   ".align 8\n"
-  "pushl %%ecx\n"
-  "pushl %%eax\n"
-  "movl $0x%08x, %%ecx\n"
+  "pushq %%rcx\n"
+  "pushq %%rax\n"
+  "movq $0x%08x, %%rcx\n"
   "call __afl_maybe_log\n"
-  "popl %%eax\n"
-  "popl %%ecx\n\n";
+  "popq %%rax\n"
+  "popq %%rcx\n\n";
 
 static const u8* main_payload = 
 
@@ -58,34 +58,34 @@
   "__afl_maybe_log:\n"
   "\n"
   "  lahf\n"
-  "  movb %ah, __afl_saved_flags\n"
+  "  movb %ah, __afl_saved_flags@GOTPCREL\n"
   "\n"
   "  /* Check if SHM region is already mapped. */\n"
   "\n"
-  "  movl __afl_area_ptr, %eax\n"
-  "  testl %eax, %eax\n"
+  "  movq __afl_area_ptr@GOTPCREL, %rax\n"
+  "  testq %rax, %rax\n"
   "  je __afl_setup\n"
   "\n"
   "__afl_store:\n"
   "\n"
   "  /* Calculate and store hit for the code location specified in ecx. */\n"
   "\n"
-  "  rorl $8, %ecx\n"
+  "  rorq $8, %rcx\n"
   "\n"
 #ifndef COVERAGE_ONLY
-  "  xorw __afl_prev_loc, %cx\n"
-  "  xorw %cx, __afl_prev_loc\n"
+  "  xorw __afl_prev_loc@GOTPCREL, %cx\n"
+  "  xorw %cx, __afl_prev_loc@GOTPCREL\n"
 #endif /* !COVERAGE_ONLY */
   "  addw %cx, %ax\n"
   "\n"
-  "  roll $8, %ecx\n"
+  "  rolq $8, %rcx\n"
 #ifdef COVERAGE_ONLY
-  "  orb  %cl, (%eax)\n"
+  "  orb  %cl, (%rax)\n"
 #else
-  "  xorb %cl, (%eax)\n"
+  "  xorb %cl, (%rax)\n"
 #endif /* ^COVERAGE_ONLY */
   "\n"
-  "  movb __afl_saved_flags, %ah\n"
+  "  movb __afl_saved_flags@GOTPCREL, %ah\n"
   "  sahf\n"
   "  ret\n"
   "\n"
@@ -95,12 +95,12 @@
   "\n"
   "  /* Do not retry setup if we had previous failures. */\n"
   "\n"
-  "  cmpb $0, __afl_setup_failure\n"
+  "  cmpb $0, __afl_setup_failure@GOTPCREL\n"
   "  je __afl_setup2\n"
   "\n"
   "__afl_return:\n"
   "\n"
-  "  movb __afl_saved_flags, %ah\n"
+  "  movb __afl_saved_flags@GOTPCREL, %ah\n"
   "  sahf\n"
   "  ret\n"
   "\n"
@@ -108,36 +108,37 @@
   "\n"
   "  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */\n"
   "\n"
-  "  pushl %ecx\n"
-  "  pushl %edx\n"
+  "  pushq %rcx\n"
+  "  pushq %rdx\n"
+  "  pushq %rdi\n"
+  "  pushq %rsi\n"
   "\n"
-  "  pushl $.AFL_SHM_ID\n"
-  "  call  getenv\n"
-  "  addl  $4, %esp\n"
+  "  movq $.AFL_SHM_ID@GOTPCREL, %rdi\n"
+  "  call  getenv@PLT\n"
   "\n"
-  "  testl %eax, %eax\n"
+  "  testq %rax, %rax\n"
   "  je __afl_setup_abort\n"
   "\n"
-  "  pushl %eax\n"
-  "  call  atoi\n"
-  "  addl  $4, %esp\n"
-  "\n"
-  "  pushl $0          /* shmat flags    */\n"
-  "  pushl $0          /* requested addr */\n"
-  "  pushl %eax        /* SHM ID         */\n"
+  "  movq  %rax, %rdi\n"
+  "  call  atoi@PLT\n"
   "\n"
-  "  call shmat\n"
-  "  addl $12, %esp\n"
+  "  xorq  %rdi, %rdi        /* shmat flags    */\n"
+  "  xorq  %rsi, %rsi        /* requested addr */\n"
+  "  movq  %rax, %rdi        /* SHM ID         */\n"
   "\n"
-  "  testl %eax, %eax\n"
+  "  call shmat@PLT\n"
+  "\n"
+  "  testq %rax, %rax\n"
   "  je __afl_setup_abort\n"
   "\n"
   "  /* Store the address of the SHM region. */\n"
   "\n"
-  "  movl %eax, __afl_area_ptr\n"
+  "  movq %rax, __afl_area_ptr@GOTPCREL\n"
   "\n"
-  "  popl %edx\n"
-  "  popl %ecx\n"
+  "  popq %rsi\n"
+  "  popq %rdi\n"
+  "  popq %rdx\n"
+  "  popq %rcx\n"
   "\n"
   "  jmp __afl_store\n"
   "\n"
@@ -146,14 +147,16 @@
   "  /* Record setup failure so that we don't keep calling\n"
   "     shmget() / shmat() over and over again. */\n"
   "\n"
-  "  incb __afl_setup_failure\n"
-  "  popl %edx\n"
-  "  popl %ecx\n"
+  "  incb __afl_setup_failure@GOTPCREL\n"
+  "  popq %rsi\n"
+  "  popq %rdi\n"
+  "  popq %rdx\n"
+  "  popq %rcx\n"
   "  jmp __afl_return\n"
   "\n"
   ".AFL_VARS:\n"
   "\n"
-  "  .comm   __afl_area_ptr, 4, 32\n"
+  "  .comm   __afl_area_ptr, 8, 32\n"
   "  .comm   __afl_setup_failure, 1, 32\n"
 #ifndef COVERAGE_ONLY
   "  .comm   __afl_prev_loc, 2, 32\n"
