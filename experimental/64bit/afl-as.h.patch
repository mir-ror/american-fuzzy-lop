--- afl-as.h.orig	2013-06-21 23:23:39.000000000 +0200
+++ afl-as.h	2013-06-22 06:05:44.000000000 +0200
@@ -40,12 +40,12 @@
   "/* --- AFL TRAMPOLINE --- */\n"
   "\n"
   ".align 8\n"
-  "pushl %%ecx\n"
-  "pushl %%eax\n"
-  "movl $0x%08x, %%ecx\n"
+  "pushq %%rcx\n"
+  "pushq %%rax\n"
+  "movq $0x%08x, %%rcx\n"
   "call __afl_maybe_log\n"
-  "popl %%eax\n"
-  "popl %%ecx\n\n";
+  "popq %%rax\n"
+  "popq %%rcx\n\n";
 
 static const u8* main_payload = 
 
@@ -62,8 +62,8 @@
   "\n"
   "  /* Check if SHM region is already mapped. */\n"
   "\n"
-  "  movl __afl_area_ptr, %eax\n"
-  "  testl %eax, %eax\n"
+  "  movq __afl_area_ptr, %rax\n"
+  "  testq %rax, %rax\n"
   "  je __afl_setup\n"
   "\n"
   "__afl_store:\n"
@@ -73,17 +73,17 @@
   "  pushw %cx\n"
   "\n"
 #ifdef COVERAGE_ONLY
-  "  shrl $8, %ecx\n"
+  "  shrq $8, %rcx\n"
 #else
   "  movb __afl_prev_loc, %cl\n"
   "  movb %ch, __afl_prev_loc\n"
   "  shlb $2, %cl\n"
   "  shrw $2, %cx\n"
 #endif /* ^COVERAGE_ONLY */
-  "  addl %ecx, %eax\n"
+  "  addq %rcx, %rax\n"
   "\n"
   "  popw %cx\n"
-  "  orb %cl, (%eax)\n"
+  "  orb %cl, (%rax)\n"
   "\n"
   "  movb __afl_saved_flags, %ah\n"
   "  sahf\n"
@@ -108,36 +108,37 @@
   "\n"
   "  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */\n"
   "\n"
-  "  pushl %ecx\n"
-  "  pushl %edx\n"
+  "  pushq %rcx\n"
+  "  pushq %rdx\n"
+  "  pushq %rdi\n"
+  "  pushq %rsi\n"
   "\n"
-  "  pushl $.AFL_SHM_ID\n"
+  "  movq $.AFL_SHM_ID, %rdi\n"
   "  call  getenv\n"
-  "  addl  $4, %esp\n"
   "\n"
-  "  testl %eax, %eax\n"
+  "  testq %rax, %rax\n"
   "  je __afl_setup_abort\n"
   "\n"
-  "  pushl %eax\n"
+  "  movq  %rax, %rdi\n"
   "  call  atoi\n"
-  "  addl  $4, %esp\n"
   "\n"
-  "  pushl $0          /* shmat flags    */\n"
-  "  pushl $0          /* requested addr */\n"
-  "  pushl %eax        /* SHM ID         */\n"
+  "  xorq  %rdi, %rdi        /* shmat flags    */\n"
+  "  xorq  %rsi, %rsi        /* requested addr */\n"
+  "  movq  %rax, %rdi        /* SHM ID         */\n"
   "\n"
   "  call shmat\n"
-  "  addl $12, %esp\n"
   "\n"
-  "  testl %eax, %eax\n"
+  "  testq %rax, %rax\n"
   "  je __afl_setup_abort\n"
   "\n"
   "  /* Store the address of the SHM region. */\n"
   "\n"
-  "  movl %eax, __afl_area_ptr\n"
+  "  movq %rax, __afl_area_ptr\n"
   "\n"
-  "  popl %edx\n"
-  "  popl %ecx\n"
+  "  popq %rsi\n"
+  "  popq %rdi\n"
+  "  popq %rdx\n"
+  "  popq %rcx\n"
   "\n"
   "  jmp __afl_store\n"
   "\n"
@@ -147,13 +148,15 @@
   "     shmget() / shmat() over and over again. */\n"
   "\n"
   "  incb __afl_setup_failure\n"
-  "  popl %edx\n"
-  "  popl %ecx\n"
+  "  popq %rsi\n"
+  "  popq %rdi\n"
+  "  popq %rdx\n"
+  "  popq %rcx\n"
   "  jmp __afl_return\n"
   "\n"
   ".AFL_VARS:\n"
   "\n"
-  "  .comm   __afl_area_ptr, 4, 32\n"
+  "  .comm   __afl_area_ptr, 8, 32\n"
   "  .comm   __afl_setup_failure, 1, 32\n"
 #ifndef COVERAGE_ONLY
   "  .comm   __afl_prev_loc, 1, 32\n"
